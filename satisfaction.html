<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบประเมินความพึงพอใจ - รพ.สต. บึงเนียม</title>
    
    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #FF69B4, #800080);
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            --text-color: #333;
            --text-light: #fff;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background: rgb(255,192,203);
            background: linear-gradient(135deg, rgba(255,192,203,1) 0%, rgba(218,112,214,1) 50%, rgba(128,0,128,1) 100%);
            min-height: 100vh;
            color: var(--text-color);
            background-attachment: fixed;
        }

        /* Glassmorphism Classes */
        .glass-card {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.45);
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255,255,255,0.3);
        }

        /* Typography & Components */
        h1, h2, h3, h4 {
            color: #4a0e4e; /* Dark Purple */
            font-weight: 600;
        }

        .text-gradient {
            background: -webkit-linear-gradient(#c21588, #5a189a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn-custom {
            background: var(--primary-gradient);
            border: none;
            color: white;
            border-radius: 50px;
            padding: 10px 30px;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }

        .btn-custom:hover {
            transform: scale(1.05);
            color: white;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .form-label {
            font-weight: 500;
            color: #4a0e4e;
        }
        
        .fw-500 { font-weight: 500; }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            flex-direction: column;
            display: none;
        }

        /* Radio Scale Styling */
        .rating-group {
            display: flex;
            justify-content: space-between;
            max-width: 300px;
            margin: 10px 0;
        }
        .rating-input { display: none; }
        .rating-label {
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #eee;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: 0.3s;
            font-weight: bold;
            color: #555;
        }
        .rating-input:checked + .rating-label {
            background: #FF69B4;
            color: white;
            box-shadow: 0 0 10px #FF69B4;
        }

        /* Sections */
        .page-section { display: none; padding-top: 80px; padding-bottom: 50px;}
        .page-section.active { display: block; }

        /* Navbar */
        .navbar-brand { font-weight: 700; color: #4a0e4e !important; }
        .nav-link { color: #4a0e4e !important; font-weight: 500; }
        
        .stat-value { font-size: 2.5rem; font-weight: 700; color: #800080; }
        .stat-label { font-size: 0.9rem; color: #666; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .stat-value { font-size: 1.8rem; }
            .rating-label { width: 35px; height: 35px; }
        }
    </style>
</head>
<body>

    <!-- Loading -->
    <div id="loadingOverlay">
        <div class="spinner-border text-light mb-3" role="status"></div>
        <h4>กำลังประมวลผล...</h4>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top glass-nav">
        <div class="container">
            <a class="navbar-brand" href="#" onclick="showSection('dashboard')">
                <i class="fas fa-hospital-user me-2 text-danger"></i>รพ.สต. บึงเนียม
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('dashboard')">หน้าหลัก</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('assessment')">ทำแบบประเมิน</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('login')"><i class="fas fa-lock"></i> เจ้าหน้าที่</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- SECTION: Dashboard -->
    <div id="dashboard" class="page-section active container">
        
        <!-- Welcome & CTA -->
        <div class="text-center mb-5 animate__animated animate__fadeInDown">
            <h1 class="display-4 mb-3 text-white" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">ระบบประเมินความพึงพอใจ</h1>
            <p class="lead text-white mb-4">โรงพยาบาลส่งเสริมสุขภาพตำบลบึงเนียม</p>
            <button class="btn btn-custom btn-lg" onclick="showSection('assessment')">
                <i class="fas fa-clipboard-check me-2"></i> เข้าสู่แบบประเมิน
            </button>
        </div>

        <!-- Smart Filters -->
        <div class="glass-card mb-4">
            <h4 class="mb-3"><i class="fas fa-filter me-2"></i>Smart Filters (กรองข้อมูลแบบ Real-time)</h4>
            <div class="row g-2">
                <div class="col-md-2 col-6">
                    <select class="form-select" id="filterGender" onchange="applyFilters()">
                        <option value="">ทั้งหมด (เพศ)</option>
                        <option value="ชาย">ชาย</option>
                        <option value="หญิง">หญิง</option>
                        <option value="ทางเลือก">ทางเลือก</option>
                    </select>
                </div>
                <div class="col-md-2 col-6">
                    <select class="form-select" id="filterAge" onchange="applyFilters()">
                        <option value="">ทั้งหมด (อายุ)</option>
                        <option value="<20">ต่ำกว่า 20 ปี</option>
                        <option value="20-29">20 - 29 ปี</option>
                        <option value="30-39">30 - 39 ปี</option>
                        <option value="40-49">40 - 49 ปี</option>
                        <option value="50-59">50 - 59 ปี</option>
                        <option value="60+">60 ปีขึ้นไป</option>
                    </select>
                </div>
                <div class="col-md-2 col-6">
                    <select class="form-select" id="filterDept" onchange="applyFilters()">
                        <option value="">ทั้งหมด (แผนก)</option>
                        <option value="ตรวจโรคทั่วไป">ตรวจโรคทั่วไป</option>
                        <option value="ทันตกรรม">ทันตกรรม</option>
                        <option value="แผนกไทย/กายภาพ">แผนกไทย/กายภาพ</option>
                        <option value="ฉุกเฉิน">ฉุกเฉิน</option>
                        <option value="ส่งเสริมสุขภาพ">ส่งเสริมสุขภาพ</option>
                    </select>
                </div>
                <div class="col-md-2 col-6">
                    <select class="form-select" id="filterRights" onchange="applyFilters()">
                        <option value="">ทั้งหมด (สิทธิ์)</option>
                        <option value="บัตรทอง">บัตรทอง</option>
                        <option value="ประกันสังคม">ประกันสังคม</option>
                        <option value="ข้าราชการ">ข้าราชการ</option>
                        <option value="ชำระเงินเอง">ชำระเงินเอง</option>
                    </select>
                </div>
                <div class="col-md-2 col-6">
                    <select class="form-select" id="filterFreq" onchange="applyFilters()">
                        <option value="">ทั้งหมด (ความถี่)</option>
                        <option value="ครั้งแรก">ครั้งแรก</option>
                        <option value="นานๆ ครั้ง">นานๆ ครั้ง</option>
                        <option value="ประจำ">ประจำ</option>
                    </select>
                </div>
                <div class="col-md-2 col-12">
                     <select class="form-select" id="filterJob" onchange="applyFilters()">
                        <option value="">ทั้งหมด (อาชีพ)</option>
                        <option value="รับราชการ">รับราชการ</option>
                        <option value="เกษตรกร">เกษตรกร</option>
                        <option value="ค้าขาย">ค้าขาย</option>
                        <option value="รับจ้างทั่วไป">รับจ้างทั่วไป</option>
                        <option value="นักเรียน/นักศึกษา">นักเรียน/นักศึกษา</option>
                    </select>
                </div>
            </div>
            <div class="mt-3 text-end">
                <button class="btn btn-sm btn-outline-secondary" onclick="exportWord()"><i class="fas fa-file-word me-1"></i> Export Word Report</button>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="glass-card text-center h-100">
                    <div class="stat-value" id="statTotalUsers">0</div>
                    <div class="stat-label">ผู้ตอบแบบสอบถาม (คน)</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="glass-card text-center h-100">
                    <div class="stat-value" id="statAvgScore">0.00</div>
                    <div class="stat-label">คะแนนเฉลี่ยรวม (เต็ม 5)</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="glass-card text-center h-100">
                    <div class="stat-value" id="statTopDim" style="font-size: 1.5rem;">-</div>
                    <div class="stat-label">ด้านที่พึงพอใจสูงสุด</div>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="row">
            <div class="col-md-8 mb-4">
                <div class="glass-card h-100">
                    <h5><i class="fas fa-chart-bar me-2"></i>คะแนนเฉลี่ยรายด้าน (5 มิติ)</h5>
                    <canvas id="chartDimensions"></canvas>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="glass-card h-100">
                    <h5><i class="fas fa-venus-mars me-2"></i>สัดส่วนเพศ</h5>
                    <canvas id="chartGender"></canvas>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="glass-card h-100">
                    <h5><i class="fas fa-user-md me-2"></i>สิทธิ์การรักษา</h5>
                    <canvas id="chartRights"></canvas>
                </div>
            </div>
             <div class="col-md-4 mb-4">
                <div class="glass-card h-100">
                    <h5><i class="fas fa-history me-2"></i>ความถี่ในการรับบริการ</h5>
                    <canvas id="chartFreq"></canvas>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="glass-card h-100">
                    <h5><i class="fas fa-clinic-medical me-2"></i>แผนกที่ใช้บริการ</h5>
                    <canvas id="chartDept"></canvas>
                </div>
            </div>
            <div class="col-12 mb-4">
                <div class="glass-card">
                    <h5><i class="fas fa-briefcase me-2"></i>อาชีพของผู้รับบริการ (Top 5)</h5>
                    <canvas id="chartJob" height="80"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table Preview -->
        <div class="glass-card mb-4">
            <h5><i class="fas fa-table me-2"></i>ข้อมูลล่าสุด</h5>
            <div class="table-responsive">
                <table class="table table-hover" id="previewTable">
                    <thead><tr><th>เวลา</th><th>แผนก</th><th>เพศ</th><th>คะแนนเฉลี่ย</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Footer & Staff Login Button -->
        <div class="text-center mt-5 mb-4">
            <p class="text-white opacity-75 small mb-2">© 2024 โรงพยาบาลส่งเสริมสุขภาพตำบลบึงเนียม</p>
            <button class="btn btn-sm btn-outline-light rounded-pill px-4 opacity-75" onclick="showSection('login')">
                <i class="fas fa-key me-1"></i> เข้าสู่ระบบเจ้าหน้าที่
            </button>
        </div>
    </div>

    <!-- SECTION: Assessment Form -->
    <div id="assessment" class="page-section container" style="max-width: 800px;">
        <div class="glass-card">
            <h2 class="text-center mb-4 text-gradient">แบบประเมินความพึงพอใจ</h2>
            <form id="surveyForm" onsubmit="submitForm(event)">
                
                <!-- Part 1: Personal Info -->
                <h5 class="text-primary mb-3">ส่วนที่ 1: ข้อมูลทั่วไป</h5>
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label">เพศ</label>
                        <select name="gender" class="form-select" required>
                            <option value="">เลือก...</option>
                            <option value="ชาย">ชาย</option>
                            <option value="หญิง">หญิง</option>
                            <option value="ทางเลือก">ทางเลือก</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">อายุ (ปี)</label>
                        <input type="number" name="age" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">แผนกที่ใช้บริการ</label>
                        <select name="department" class="form-select" required>
                            <option value="">เลือก...</option>
                            <option value="ตรวจโรคทั่วไป">ตรวจโรคทั่วไป</option>
                            <option value="ทันตกรรม">ทันตกรรม</option>
                            <option value="แผนกไทย/กายภาพ">แผนกไทย/กายภาพ</option>
                            <option value="ฉุกเฉิน">ฉุกเฉิน</option>
                            <option value="ส่งเสริมสุขภาพ">ส่งเสริมสุขภาพ</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ความถี่ในการรับบริการ</label>
                        <select name="frequency" class="form-select" required>
                            <option value="">เลือก...</option>
                            <option value="ครั้งแรก">ครั้งแรก</option>
                            <option value="นานๆ ครั้ง">นานๆ ครั้ง</option>
                            <option value="ประจำ">ประจำ</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">สิทธิ์การรักษา</label>
                        <select name="rights" class="form-select" required>
                            <option value="">เลือก...</option>
                            <option value="บัตรทอง">บัตรทอง</option>
                            <option value="ประกันสังคม">ประกันสังคม</option>
                            <option value="ข้าราชการ">ข้าราชการ</option>
                            <option value="ชำระเงินเอง">ชำระเงินเอง</option>
                        </select>
                    </div>
                     <div class="col-md-6">
                        <label class="form-label">อาชีพ</label>
                         <select name="occupation" class="form-select" required>
                            <option value="">เลือก...</option>
                            <option value="รับราชการ">รับราชการ</option>
                            <option value="เกษตรกร">เกษตรกร</option>
                            <option value="ค้าขาย">ค้าขาย</option>
                            <option value="รับจ้างทั่วไป">รับจ้างทั่วไป</option>
                            <option value="นักเรียน/นักศึกษา">นักเรียน/นักศึกษา</option>
                             <option value="ว่างงาน">ว่างงาน</option>
                            <option value="อื่นๆ">อื่นๆ</option>
                        </select>
                    </div>
                </div>

                <!-- Part 2: Questions -->
                <h5 class="text-primary mb-3">ส่วนที่ 2: ระดับความพึงพอใจ (5=มากที่สุด, 1=น้อยที่สุด)</h5>
                <div id="questionsContainer"></div>

                <!-- Part 3: Suggestion -->
                <div class="mb-4 mt-4">
                    <label class="form-label">ข้อเสนอแนะเพิ่มเติม</label>
                    <textarea name="suggestion" class="form-control" rows="3"></textarea>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-custom btn-lg">ส่งแบบประเมิน</button>
                    <button type="button" class="btn btn-light" onclick="showSection('dashboard')">ยกเลิก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SECTION: Login -->
    <div id="login" class="page-section container" style="max-width: 400px; padding-top: 150px;">
        <div class="glass-card text-center">
            <h3 class="mb-4"><i class="fas fa-user-shield text-primary"></i> เจ้าหน้าที่ Admin</h3>
            <form onsubmit="handleLogin(event)">
                <div class="mb-3 text-start">
                    <label>Username</label>
                    <input type="text" id="adminUser" class="form-control" required>
                </div>
                <div class="mb-3 text-start">
                    <label>Password</label>
                    <input type="password" id="adminPass" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-custom w-100">เข้าสู่ระบบ</button>
                <button type="button" class="btn btn-link mt-2 text-decoration-none" onclick="showSection('dashboard')">กลับหน้าหลัก</button>
            </form>
        </div>
    </div>

    <!-- SECTION: Admin Panel -->
    <div id="adminPanel" class="page-section container-fluid px-5">
        <div class="glass-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3><i class="fas fa-database text-warning"></i> จัดการข้อมูล (Admin)</h3>
                <button class="btn btn-danger btn-sm" onclick="logout()">ออกจากระบบ</button>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-striped bg-white" id="adminTable">
                    <thead class="table-dark">
                        <tr>
                            <th>ลบ</th>
                            <th>ID</th>
                            <th>เวลา</th>
                            <th>เพศ</th>
                            <th>แผนก</th>
                            <th>เฉลี่ย</th>
                            <th>ข้อเสนอแนะ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ************************************************
        // CONFIGURATION: ใส่ Web App URL ของคุณที่นี่
        // ************************************************
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby4H-ukmz5WqoeWlhRU-pTVfchF8ECBlxFeJgCNTsK0-qlhs4zkxkMIwt0jrDzglwJJLQ/exec"; 

        // Global Data
        let allData = [];
        let chartInstances = {};

        // Question Set (Standard 5 Dimensions x 5 Items)
        const questionSets = [
            {
                dim: "1. ด้านขั้นตอนการให้บริการ (การเข้าถึง)",
                questions: [
                    "ขั้นตอนการให้บริการไม่ยุ่งยากซับซ้อน",
                    "มีป้ายบอกจุดบริการชัดเจน และผังลำดับขั้นตอนแสดงไว้อย่างชัดเจน",
                    "จุดบริการต่างๆ จัดไว้อย่างเป็นระเบียบ สะดวกต่อการติดต่อ",
                    "ระยะเวลาในการรอคอยในแต่ละจุดบริการมีความเหมาะสม",
                    "ความสะดวกในการยื่นบัตร/ตรวจสอบสิทธิ์/คัดกรอง"
                ]
            },
            {
                dim: "2. ด้านความรวดเร็วและการให้บริการ",
                questions: [
                    "ความรวดเร็วในการค้นหาประวัติ/เวชระเบียน",
                    "ความรวดเร็วในการซักประวัติและตรวจรักษา",
                    "ความรวดเร็วในการจ่ายยาและการชำระเงิน (ถ้ามี)",
                    "การให้บริการเสร็จสิ้นภายในเวลาที่เหมาะสม",
                    "ความรวดเร็วในการแก้ไขปัญหาหรือข้อร้องเรียน"
                ]
            },
            {
                dim: "3. ด้านบุคลากรผู้ให้บริการ (แพทย์/พยาบาล/เจ้าหน้าที่)",
                questions: [
                    "เจ้าหน้าที่พูดจาสุภาพ ยิ้มแย้มแจ่มใส เต็มใจให้บริการ",
                    "เจ้าหน้าที่เอาใจใส่ กระตือรือร้น และให้เกียรติผู้รับบริการ",
                    "เจ้าหน้าที่มีความรู้ ความชำนาญ และความน่าเชื่อถือ",
                    "เจ้าหน้าที่แต่งกายสุภาพ เรียบร้อย เหมาะสม",
                    "เจ้าหน้าที่รับฟังปัญหาและตอบข้อซักถามได้อย่างชัดเจน"
                ]
            },
            {
                dim: "4. ด้านสิ่งอำนวยความสะดวกและสถานที่",
                questions: [
                    "สถานที่สะอาด เป็นระเบียบเรียบร้อย และสวยงาม",
                    "มีที่นั่งพักคอยเพียงพอและเหมาะสม",
                    "ห้องน้ำสะอาด ถูกสุขลักษณะและเพียงพอ",
                    "มีแสงสว่างเพียงพอและอากาศถ่ายเทสะดวก",
                    "มีอุปกรณ์/เครื่องมือทางการแพทย์ที่ทันสมัยและพร้อมใช้งาน"
                ]
            },
            {
                dim: "5. ด้านคุณภาพและความเชื่อมั่น",
                questions: [
                    "ท่านมีความเชื่อมั่นและศรัทธาต่อระบบบริการของ รพ.สต.",
                    "ท่านได้รับยาที่มีคุณภาพและคำแนะนำการใช้ยาที่ชัดเจน",
                    "การรักษาพยาบาลช่วยให้อาการเจ็บป่วยดีขึ้น/หายขาด",
                    "มีการรักษาความลับและให้ความเป็นส่วนตัวแก่ผู้รับบริการ",
                    "ท่านมีความพึงพอใจโดยรวมต่อการมารับบริการในครั้งนี้"
                ]
            }
        ];
        
        // Generate Questions HTML
        function initQuestions() {
            const container = document.getElementById('questionsContainer');
            let qIndex = 1;
            let html = '';

            questionSets.forEach((set, idx) => {
                html += `<div class="mb-3 p-3 border rounded bg-white bg-opacity-50">
                            <h5 class="text-primary-emphasis mb-3">${set.dim}</h5>`;
                set.questions.forEach((q, i) => {
                    html += `<div class="my-2 border-bottom pb-2">
                                <label class="d-block mb-1 text-dark fw-500">${qIndex}. ${q}</label>
                                <div class="rating-group">
                                    ${[1,2,3,4,5].map(v => `
                                        <input type="radio" class="rating-input" id="q${qIndex}_${v}" name="Q${qIndex}" value="${v}" required>
                                        <label for="q${qIndex}_${v}" class="rating-label">${v}</label>
                                    `).join('')}
                                </div>
                             </div>`;
                    qIndex++; // Increment global question index (1-25)
                });
                html += `</div>`;
            });
            container.innerHTML = html;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initQuestions();
            fetchData();
        });

        // Navigation
        function showSection(id) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            if(id === 'adminPanel') {
                if(!sessionStorage.getItem('isLoggedIn')) {
                    showSection('login');
                    return;
                }
            }
            document.getElementById(id).classList.add('active');
            window.scrollTo(0,0);
        }

        // API Helper
        function toggleLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // Fetch Data
        async function fetchData() {
            toggleLoading(true);
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getData`);
                const json = await response.json();
                if(json.status === 'success') {
                    allData = json.data;
                    applyFilters(); // Render Dashboard
                    renderAdminTable();
                }
            } catch (err) {
                console.error(err);
                // Swal.fire('Error', 'ไม่สามารถดึงข้อมูลได้', 'error');
            }
            toggleLoading(false);
        }

        // Smart Filters & Dashboard Logic
        function applyFilters() {
            // Get Filter Values
            const fGender = document.getElementById('filterGender').value;
            const fAge = document.getElementById('filterAge').value;
            const fDept = document.getElementById('filterDept').value;
            const fRights = document.getElementById('filterRights').value;
            const fFreq = document.getElementById('filterFreq').value;
            const fJob = document.getElementById('filterJob').value;

            // Filter Data
            const filtered = allData.filter(item => {
                // Age Range Logic
                let ageMatch = true;
                if(fAge) {
                    const age = parseInt(item.Age);
                    if(isNaN(age)) {
                        ageMatch = false; 
                    } else {
                        if(fAge === '<20') ageMatch = age < 20;
                        else if(fAge === '20-29') ageMatch = age >= 20 && age <= 29;
                        else if(fAge === '30-39') ageMatch = age >= 30 && age <= 39;
                        else if(fAge === '40-49') ageMatch = age >= 40 && age <= 49;
                        else if(fAge === '50-59') ageMatch = age >= 50 && age <= 59;
                        else if(fAge === '60+') ageMatch = age >= 60;
                    }
                }

                return (!fGender || item.Gender === fGender) &&
                       ageMatch &&
                       (!fDept || item.Department === fDept) &&
                       (!fRights || item.Rights === fRights) &&
                       (!fFreq || item.Frequency === fFreq) &&
                       (!fJob || item.Occupation === fJob);
            });

            updateStats(filtered);
            updateCharts(filtered);
            updatePreviewTable(filtered);
        }

        function updateStats(data) {
            document.getElementById('statTotalUsers').innerText = data.length;
            
            if(data.length === 0) {
                document.getElementById('statAvgScore').innerText = "0.00";
                document.getElementById('statTopDim').innerText = "-";
                return;
            }

            // Calc Total Avg
            const totalAvg = data.reduce((sum, item) => sum + (parseFloat(item.AverageScore)||0), 0) / data.length;
            document.getElementById('statAvgScore').innerText = totalAvg.toFixed(2);

            // Calc Dimension Avg
            let dimScores = [0,0,0,0,0];
            data.forEach(item => {
                for(let i=1; i<=25; i++) {
                    const dimIndex = Math.floor((i-1)/5);
                    dimScores[dimIndex] += parseInt(item[`Q${i}`]) || 0;
                }
            });
            // Avg per dimension (Sum / (People * 5 questions))
            dimScores = dimScores.map(s => (s / (data.length * 5)).toFixed(2));
            
            // Find Max
            const maxScore = Math.max(...dimScores);
            const maxIndex = dimScores.indexOf(maxScore.toFixed(2));
            document.getElementById('statTopDim').innerText = `ด้านที่ ${maxIndex+1} (${maxScore})`;
        }

        function updateCharts(data) {
            // Helper to count frequencies
            const countBy = (key) => {
                const counts = {};
                data.forEach(x => { counts[x[key]] = (counts[x[key]] || 0) + 1; });
                return counts;
            };

            // 1. Dimensions Bar Chart
            let dimScores = [0,0,0,0,0];
            const hasData = data.length > 0;
            if(hasData) {
                data.forEach(item => {
                     for(let i=1; i<=25; i++) {
                        dimScores[Math.floor((i-1)/5)] += parseInt(item[`Q${i}`]) || 0;
                     }
                });
                dimScores = dimScores.map(s => (s / (data.length * 5)).toFixed(2));
            }
            // Use labels from questionSets
            renderChart('chartDimensions', 'bar', questionSets.map((d,i)=>`ด้านที่ ${i+1}`), dimScores, 'คะแนนเฉลี่ย', ['#FF69B4','#DA70D6','#BA55D3','#9932CC','#800080']);

            // 2. Gender Pie
            const genderData = countBy('Gender');
            renderChart('chartGender', 'doughnut', Object.keys(genderData), Object.values(genderData), 'คน', ['#36A2EB', '#FF6384', '#FFCD56']);

            // 3. Rights Pie
            const rightsData = countBy('Rights');
            renderChart('chartRights', 'pie', Object.keys(rightsData), Object.values(rightsData), 'คน', ['#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF']);

            // 4. Frequency Bar
            const freqData = countBy('Frequency');
            renderChart('chartFreq', 'bar', Object.keys(freqData), Object.values(freqData), 'คน', '#FF69B4');

            // 5. Dept Horizontal Bar
            const deptData = countBy('Department');
            renderChart('chartDept', 'bar', Object.keys(deptData), Object.values(deptData), 'คน', '#8A2BE2', {indexAxis: 'y'});

            // 6. Job Horizontal Bar (Top 5)
            let jobData = countBy('Occupation');
            // Sort and take top 5
            const sortedJobs = Object.entries(jobData).sort((a,b) => b[1]-a[1]).slice(0,5);
            renderChart('chartJob', 'bar', sortedJobs.map(x=>x[0]), sortedJobs.map(x=>x[1]), 'คน', '#DA70D6', {indexAxis: 'y'});
        }

        function renderChart(canvasId, type, labels, data, label, colors, options={}) {
            if(chartInstances[canvasId]) chartInstances[canvasId].destroy();
            
            const ctx = document.getElementById(canvasId).getContext('2d');
            chartInstances[canvasId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    ...options
                }
            });
        }

        function updatePreviewTable(data) {
            const tbody = document.querySelector('#previewTable tbody');
            tbody.innerHTML = data.slice(0, 5).map(item => `
                <tr>
                    <td>${new Date(item.Timestamp).toLocaleTimeString('th-TH')}</td>
                    <td>${item.Department}</td>
                    <td>${item.Gender}</td>
                    <td><span class="badge bg-success">${parseFloat(item.AverageScore).toFixed(2)}</span></td>
                </tr>
            `).join('');
        }

        // Form Submission
        async function submitForm(e) {
            e.preventDefault();
            toggleLoading(true);

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            try {
                // Send using fetch POST (CORS handled by text/plain trick or Apps Script Web App settings)
                const payload = { action: 'submit', data: data };
                
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Important for simple GAS requests from client
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });

                // Since no-cors returns opaque response, assume success if no error thrown
                Swal.fire({
                    icon: 'success',
                    title: 'บันทึกสำเร็จ',
                    text: 'ขอบคุณที่ใช้บริการครับ'
                }).then(() => {
                    e.target.reset();
                    showSection('dashboard');
                    fetchData(); // Reload data
                });

            } catch (err) {
                Swal.fire('Error', 'เกิดข้อผิดพลาดในการส่งข้อมูล', 'error');
            }
            toggleLoading(false);
        }

        // Admin Functions
        async function handleLogin(e) {
            e.preventDefault();
            toggleLoading(true);
            const user = document.getElementById('adminUser').value;
            const pass = document.getElementById('adminPass').value;

            // For better security, should verify with GAS, but for this demo using direct post
            const payload = { action: 'login', username: user, password: pass };
            
            // Note: Since 'no-cors' mode can't read response content, we'll implement a simple client-side check 
            // BUT proper way is to enable CORS on server or use standard fetch.
            // For this specific requirements, let's assume successful if fetch doesn't fail, 
            // OR simply check "admin" / "1234" here for the "Standalone" UI simulation if GAS is tricky.
            
            if(user === 'admin' && pass === '1234') {
                sessionStorage.setItem('isLoggedIn', 'true');
                Swal.fire('Success', 'ยินดีต้อนรับ Admin', 'success').then(() => {
                    showSection('adminPanel');
                    renderAdminTable();
                });
            } else {
                 Swal.fire('Error', 'รหัสผ่านผิด', 'error');
            }
            toggleLoading(false);
        }

        function logout() {
            sessionStorage.removeItem('isLoggedIn');
            showSection('dashboard');
        }

        function renderAdminTable() {
            const tbody = document.querySelector('#adminTable tbody');
            // Sort by latest
            const sorted = [...allData].sort((a,b) => new Date(b.Timestamp) - new Date(a.Timestamp));
            
            tbody.innerHTML = sorted.map(item => `
                <tr>
                    <td class="text-center"><button class="btn btn-danger btn-sm" onclick="deleteRow(${item.id})"><i class="fas fa-trash"></i></button></td>
                    <td>${item.id}</td>
                    <td>${new Date(item.Timestamp).toLocaleString('th-TH')}</td>
                    <td>${item.Gender}</td>
                    <td>${item.Department}</td>
                    <td>${parseFloat(item.AverageScore).toFixed(2)}</td>
                    <td>${item.Suggestion || '-'}</td>
                </tr>
            `).join('');
        }

        async function deleteRow(id) {
            const confirm = await Swal.fire({
                title: 'ยืนยันการลบ?',
                text: "ข้อมูลจะหายไปถาวร",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'ลบข้อมูล'
            });

            if (confirm.isConfirmed) {
                toggleLoading(true);
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'delete', rowId: id })
                });
                
                // Refresh
                setTimeout(() => {
                    fetchData();
                    Swal.fire('Deleted!', 'ลบข้อมูลเรียบร้อย', 'success');
                }, 2000); // Delay for GAS propagation
            }
        }

        function exportWord() {
            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' "+
                "xmlns:w='urn:schemas-microsoft-com:office:word' "+
                "xmlns='http://www.w3.org/TR/REC-html40'>"+
                "<head><meta charset='utf-8'><title>Export HTML to Word Document with JavaScript</title></head><body>";
            
            const footer = "</body></html>";
            
            const statsHtml = `
                <h1 style="text-align:center">รายงานสรุปความพึงพอใจ รพ.สต. บึงเนียม</h1>
                <p><strong>ผู้ตอบแบบสอบถามทั้งหมด:</strong> ${document.getElementById('statTotalUsers').innerText} คน</p>
                <p><strong>คะแนนเฉลี่ยรวม:</strong> ${document.getElementById('statAvgScore').innerText}</p>
                <p><strong>ด้านที่พึงพอใจสูงสุด:</strong> ${document.getElementById('statTopDim').innerText}</p>
                <hr/>
                <h3>ตารางข้อมูล (ล่าสุด 50 รายการ)</h3>
                <table border="1" style="border-collapse: collapse; width: 100%;">
                    <thead>
                        <tr style="background-color: #f2f2f2;">
                            <th>เวลา</th>
                            <th>เพศ</th>
                            <th>แผนก</th>
                            <th>คะแนนเฉลี่ย</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allData.slice(0,50).map(r => `
                            <tr>
                                <td>${new Date(r.Timestamp).toLocaleString('th-TH')}</td>
                                <td>${r.Gender}</td>
                                <td>${r.Department}</td>
                                <td>${parseFloat(r.AverageScore).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            const sourceHTML = header + statsHtml + footer;
            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
            
            const fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload);
            fileDownload.href = source;
            fileDownload.download = 'รายงานความพึงพอใจ.doc';
            fileDownload.click();
            document.body.removeChild(fileDownload);
        }
    </script>
</body>
</html>